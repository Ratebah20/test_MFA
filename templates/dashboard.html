{% extends 'base.html' %}

{% block title %}Dashboard - Orange Selfcare Simulation{% endblock %}

{% block content %}
<div class="container dashboard-container">
    <div class="welcome-banner">
        <h1>Bienvenue sur votre espace Selfcare</h1>
        <p>Authentification réussie via le système OTP</p>
    </div>
    
    <div class="dashboard-content">
        <div class="user-profile-card">
            <div class="card-header">
                <h2>Informations utilisateur</h2>
            </div>
            <div class="card-body">
                <div class="user-avatar">
                    <img src="{{ url_for('static', filename='img/user-avatar.png') }}" alt="Avatar utilisateur">
                </div>
                <div class="user-info">
                    <p><strong>ID Utilisateur:</strong> <span id="user-id">{{ user_id }}</span></p>
                    <p><strong>Statut:</strong> <span class="status-badge active">Actif</span></p>
                    <p><strong>Dernière connexion:</strong> <span id="last-login">Aujourd'hui</span></p>
                </div>
            </div>
        </div>
        
        <div class="auth-info-card">
            <div class="card-header">
                <h2>Informations d'authentification</h2>
            </div>
            <div class="card-body">
                <p><strong>Type de token:</strong> {{ token_type }}</p>
                <p><strong>Expiration du token:</strong> <span id="token-expiry">{{ expires_in }} secondes</span></p>
                <p><strong>Source d'authentification:</strong> Portail Orange via OTP</p>
                <div class="auth-actions">
                    <button id="refresh-token-btn" class="btn secondary-btn">Rafraîchir le token</button>
                </div>
            </div>
        </div>
        
        <div class="subscription-card">
            <div class="card-header">
                <h2>Vos abonnements</h2>
            </div>
            <div class="card-body">
                <div class="subscription-item">
                    <div class="subscription-info">
                        <h3>Mobile Premium</h3>
                        <p>Abonnement actif depuis: <strong>15/01/2023</strong></p>
                        <p>Prochain renouvellement: <strong>15/06/2025</strong></p>
                    </div>
                    <div class="subscription-status">
                        <span class="status-badge active">Actif</span>
                    </div>
                </div>
                
                <div class="subscription-usage">
                    <h4>Consommation</h4>
                    <div class="usage-item">
                        <label>Data</label>
                        <div class="progress-bar">
                            <div class="progress" style="width: 65%;"></div>
                        </div>
                        <span>65% (6.5 GB / 10 GB)</span>
                    </div>
                    <div class="usage-item">
                        <label>Appels</label>
                        <div class="progress-bar">
                            <div class="progress" style="width: 30%;"></div>
                        </div>
                        <span>30% (45 min / 150 min)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="dashboard-actions">
        <h2>Simulations disponibles</h2>
        <div class="action-buttons">
            <a href="{{ url_for('logout') }}" class="btn primary-btn">Se déconnecter</a>
            <a href="{{ url_for('simulate_redirect') }}" class="btn secondary-btn">Simuler une autre redirection</a>
            <a href="{{ url_for('simulate_first_login') }}" class="btn secondary-btn">Simuler première connexion</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Obtenir les informations utilisateur via API
        fetch('{{ url_for("user_info") }}')
            .then(response => response.json())
            .then(data => {
                // Mise à jour de la dernière connexion
                document.getElementById('last-login').textContent = data.last_login;
            })
            .catch(error => console.error('Erreur lors de la récupération des informations utilisateur:', error));
        
        // Timer pour mettre à jour le temps d'expiration du token
        const tokenExpiryElement = document.getElementById('token-expiry');
        let expiresIn = {{ expires_in }};
        
        const updateExpiry = () => {
            expiresIn -= 1;
            if (expiresIn <= 0) {
                tokenExpiryElement.textContent = 'Expiré';
                tokenExpiryElement.classList.add('expired');
                clearInterval(interval);
            } else {
                tokenExpiryElement.textContent = `${expiresIn} secondes`;
            }
        };
        
        const interval = setInterval(updateExpiry, 1000);
        
        // Bouton de rafraîchissement du token
        document.getElementById('refresh-token-btn').addEventListener('click', function() {
            alert('Cette fonctionnalité simulerait le rafraîchissement du token d\'accès en utilisant le refresh_token.');
            // Dans une implémentation réelle, vous appelleriez une API pour rafraîchir le token
        });
    });
</script>
{% endblock %}
